<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Empire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #121212;
            color: #fff;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 10px;
            box-sizing: border-box;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .round-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
            border: none;
        }
        
        .round-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
        }
        
        .round-btn:active {
            transform: scale(0.98);
        }
        
        .balance-container {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 20px;
        }
        
        .balance-item {
            display: flex;
            justify-content: space-between;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
            font-size: 14px;
        }
        
        .balance-amount {
            font-weight: bold;
            color: #6e8efb;
        }
        
        .main-content {
            min-height: 300px;
            margin-bottom: 80px;
            transition: opacity 0.5s;
        }
        
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            background: #1e1e1e;
            padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.5);
            z-index: 100;
        }
        
        .footer-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: white;
            text-decoration: none;
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 10px;
            transition: background 0.3s;
        }
        
        .footer-btn i {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        .footer-btn.active {
            background: rgba(110, 142, 251, 0.3);
        }
        
        .footer-btn:hover {
            background: rgba(110, 142, 251, 0.2);
        }
        
        .city-btn {
            background: linear-gradient(135deg, #4facfe, #00f2fe);
            width: 60px;
            height: 60px;
            margin-top: -20px;
            z-index: 101;
        }
        
        .shop-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            transition: transform 0.3s;
        }
        
        .shop-item:hover {
            transform: translateY(-5px);
        }
        
        .shop-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .shop-item-price {
            color: #a777e3;
        }
        
        .shop-item-desc {
            font-size: 12px;
            margin-bottom: 10px;
            color: #aaa;
        }
        
        .shop-item-btn {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            transition: opacity 0.3s;
        }
        
        .shop-item-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .premium-badge {
            background: linear-gradient(135deg, #f6d365, #fda085);
            color: #000;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .roulette-container {
            text-align: center;
            padding: 20px;
        }
        
        .roulette-wheel {
            width: 250px;
            height: 250px;
            margin: 0 auto 20px;
            position: relative;
            border-radius: 50%;
            overflow: hidden;
            background: conic-gradient(
                #ff7676, #f54ea2, #a777e3, #6e8efb, 
                #4facfe, #00f2fe, #17ead9, #6e8efb, 
                #a777e3, #f54ea2, #ff7676
            );
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            transition: transform 3s cubic-bezier(0.17, 0.67, 0.12, 0.99);
        }
        
        .roulette-pointer {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 20px;
            background: #fff;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            z-index: 10;
        }
        
        .spin-btn {
            background: linear-gradient(135deg, #f6d365, #fda085);
            border: none;
            color: #000;
            padding: 12px 25px;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }
        
        .spin-btn:hover {
            transform: scale(1.05);
        }
        
        .spin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .leaderboard {
            margin-top: 20px;
        }
        
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            margin-bottom: 5px;
            border-radius: 5px;
        }
        
        .leaderboard-position {
            font-weight: bold;
            color: #6e8efb;
            width: 30px;
        }
        
        .leaderboard-name {
            flex-grow: 1;
            margin: 0 10px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .leaderboard-value {
            font-weight: bold;
        }
        
        .exchange-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .exchange-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
        }
        
        .exchange-title {
            margin-bottom: 10px;
            font-weight: bold;
            color: #6e8efb;
        }
        
        .exchange-input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: none;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-bottom: 10px;
            box-sizing: border-box;
        }
        
        .exchange-btn {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border: none;
            color: white;
            padding: 10px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
        }
        
        .premium-card {
            background: linear-gradient(135deg, #f6d365, #fda085);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            color: #000;
        }
        
        .premium-title {
            font-weight: bold;
            font-size: 18px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }
        
        .premium-price {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .premium-benefits {
            font-size: 14px;
            margin-bottom: 15px;
        }
        
        .premium-benefit {
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .premium-benefit i {
            margin-right: 5px;
        }
        
        .premium-btn {
            background: #000;
            color: #f6d365;
            border: none;
            padding: 10px;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }
        
        .building {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }
        
        .building-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .building-name {
            font-weight: bold;
            font-size: 16px;
        }
        
        .building-level {
            background: rgba(110, 142, 251, 0.3);
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
        }
        
        .building-production {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 10px;
        }
        
        .building-upgrade {
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            border: none;
            color: white;
            padding: 8px;
            border-radius: 5px;
            cursor: pointer;
            width: 100%;
            font-weight: bold;
            font-size: 14px;
        }
        
        .building-upgrade:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .event-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .event-title {
            font-weight: bold;
            margin-bottom: 10px;
            color: #f6d365;
        }
        
        .event-desc {
            font-size: 14px;
            margin-bottom: 10px;
        }
        
        .event-reward {
            font-size: 12px;
            color: #aaa;
        }
        
        .fade-in {
            animation: fadeIn 0.5s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in-right {
            animation: slideInRight 0.5s;
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .slide-in-left {
            animation: slideInLeft 0.5s;
        }
        
        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            z-index: 1000;
            animation: fadeInOut 3s;
            opacity: 0;
        }
        
        @keyframes fadeInOut {
            0% { opacity: 0; top: 10px; }
            10% { opacity: 1; top: 20px; }
            90% { opacity: 1; top: 20px; }
            100% { opacity: 0; top: 10px; }
        }
        
        .withdraw-warning {
            font-size: 12px;
            color: #ff7676;
            margin-top: 10px;
            text-align: center;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="round-btn" id="energyRouletteBtn">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="round-btn" id="luckRouletteBtn">
                <i class="fas fa-dice"></i>
            </div>
            <div class="round-btn" id="premiumBtn">
                <i class="fas fa-crown"></i>
            </div>
        </div>
        
        <div class="balance-container">
            <div class="balance-item">
                <span>Энергия:</span>
                <span class="balance-amount" id="energyBalance">0</span>
            </div>
            <div class="balance-item">
                <span>Gamma Coin:</span>
                <span class="balance-amount" id="gammaBalance">0</span>
            </div>
            <div class="balance-item">
                <span>TON:</span>
                <span class="balance-amount" id="tonBalance">0</span>
            </div>
        </div>
        
        <div class="main-content" id="mainContent">
            <!-- Контент будет динамически загружаться здесь -->
        </div>
        
        <div class="footer">
            <div class="footer-btn" id="eventsBtn">
                <i class="fas fa-calendar-alt"></i>
                <span>Ивенты</span>
            </div>
            <div class="footer-btn" id="shopBtn">
                <i class="fas fa-shopping-cart"></i>
                <span>Магазин</span>
            </div>
            <div class="round-btn city-btn" id="cityBtn">
                <i class="fas fa-city"></i>
            </div>
            <div class="footer-btn" id="leaderboardBtn">
                <i class="fas fa-trophy"></i>
                <span>Лидеры</span>
            </div>
            <div class="footer-btn" id="exchangeBtn">
                <i class="fas fa-exchange-alt"></i>
                <span>Обмен</span>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Данные пользователя
        let userData = {
            energy: 0,
            gamma: 0,
            ton: 0,
            buildings: {
                solar: { level: 0, count: 0 },
                wind: { level: 0, count: 0 },
                water: { level: 0, count: 0 },
                premium: { level: 0, count: 0 }
            },
            premium: {
                active: false,
                expires: null,
                permanent: false
            },
            lastEnergyRoulette: null,
            lastLuckRoulette: null,
            joinDate: new Date().toISOString(),
            lastPlayed: new Date().toISOString()
        };
        
        // Цены и параметры зданий
        const buildingData = {
            solar: {
                name: "Солнечная батарея",
                basePrice: 7,
                baseProduction: 700,
                levelPrices: [0, 10, 37, 54, 107],
                levelProduction: [0, 1000, 2100, 4400, 5700]
            },
            wind: {
                name: "Воздушная батарея",
                basePrice: 21,
                baseProduction: 2100,
                levelPrices: [0, 58, 127, 256, 448],
                levelProduction: [0, 4400, 5700, 9600, 17300]
            },
            water: {
                name: "Водная батарея",
                basePrice: 76,
                baseProduction: 5700,
                levelPrices: [0, 148, 272, 437, 821],
                levelProduction: [0, 9600, 17300, 26700, 48400]
            },
            premium: {
                name: "Квантовая батарея",
                basePrice: 150,
                baseProduction: 15000,
                levelPrices: [0, 300, 600, 1200, 2400],
                levelProduction: [0, 30000, 60000, 120000, 240000]
            }
        };
        
        // Премиум предложения
        const premiumOffers = {
            monthly: {
                price: 5,
                duration: 30 * 24 * 60 * 60 * 1000, // 30 дней в миллисекундах
                name: "Премиум на месяц"
            },
            permanent: {
                price: 30,
                duration: null,
                name: "Премиум навсегда"
            }
        };
        
        // Курсы обмена
        const exchangeRates = {
            energyToGamma: 10000,
            gammaToEnergy: 10,
            tonToGamma: 10000,
            gammaToTon: 10000000,
            gammaToTonRate: 5
        };
        
        // Минимальные и максимальные суммы для пополнения/вывода
        const limits = {
            depositMin: 1,
            depositMax: 100,
            withdrawMin: 1,
            withdrawDays: 100
        };
        
        // Ивенты
        const events = [
            {
                id: 1,
                title: "Энергетический бум",
                description: "Получите двойную выработку энергии на 24 часа!",
                reward: "x2 к производству энергии",
                active: false,
                duration: 24 * 60 * 60 * 1000,
                multiplier: 2
            },
            {
                id: 2,
                title: "Удачный день",
                description: "Шанс выиграша в рулетке удачи увеличен на 50%!",
                reward: "+50% к шансам в рулетке удачи",
                active: false,
                duration: 24 * 60 * 60 * 1000,
                luckMultiplier: 1.5
            },
            {
                id: 3,
                title: "Скидка на здания",
                description: "Все здания в магазине со скидкой 20%!",
                reward: "20% скидка на здания",
                active: false,
                duration: 24 * 60 * 60 * 1000,
                discount: 0.8
            }
        ];
        
        // Лидерборд (заглушка, будет заполняться с сервера)
        let leaderboard = [];
        
        // Текущий активный экран
        let currentScreen = 'city';
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', function() {
            // Загружаем данные пользователя
            loadUserData();
            
            // Устанавливаем обработчики кнопок
            setupEventListeners();
            
            // Показываем город по умолчанию
            showCityScreen();
            
            // Запускаем таймер для производства энергии
            setInterval(updateProduction, 1000);
            
            // Запускаем проверку ивентов
            checkEvents();
            
            // Обновляем баланс на экране
            updateBalanceDisplay();
        });
        
        // Загрузка данных пользователя
        function loadUserData() {
            const savedData = localStorage.getItem('energyEmpireUserData');
            if (savedData) {
                userData = JSON.parse(savedData);
                
                // Проверяем истек ли премиум
                if (userData.premium.active && !userData.premium.permanent) {
                    const now = new Date();
                    const expires = new Date(userData.premium.expires);
                    if (now > expires) {
                        userData.premium.active = false;
                        userData.premium.expires = null;
                        showNotification('Ваш премиум статус истек');
                    }
                }
                
                // Проверяем когда пользователь последний раз играл
                const lastPlayed = new Date(userData.lastPlayed);
                const now = new Date();
                const diffHours = (now - lastPlayed) / (1000 * 60 * 60);
                
                // Начисляем энергию за время отсутствия (макс 24 часа)
                if (diffHours > 1) {
                    const hours = Math.min(diffHours, 24);
                    const production = calculateHourlyProduction();
                    const energyEarned = Math.floor(production * hours);
                    
                    userData.energy += energyEarned;
                    showNotification(`За время вашего отсутствия начислено ${energyEarned} энергии`);
                }
                
                userData.lastPlayed = now.toISOString();
                saveUserData();
            } else {
                // Новый пользователь
                userData.joinDate = new Date().toISOString();
                userData.lastPlayed = new Date().toISOString();
                saveUserData();
            }
        }
        
        // Сохранение данных пользователя
        function saveUserData() {
            localStorage.setItem('energyEmpireUserData', JSON.stringify(userData));
            
            // Здесь должна быть синхронизация с сервером
            // В реальном приложении нужно отправлять данные на сервер
            // syncWithServer();
        }
        
        // Установка обработчиков событий
        function setupEventListeners() {
            // Кнопки нижнего меню
            document.getElementById('eventsBtn').addEventListener('click', showEventsScreen);
            document.getElementById('shopBtn').addEventListener('click', showShopScreen);
            document.getElementById('cityBtn').addEventListener('click', showCityScreen);
            document.getElementById('leaderboardBtn').addEventListener('click', showLeaderboardScreen);
            document.getElementById('exchangeBtn').addEventListener('click', showExchangeScreen);
            
            // Кнопки верхнего меню
            document.getElementById('energyRouletteBtn').addEventListener('click', showEnergyRouletteScreen);
            document.getElementById('luckRouletteBtn').addEventListener('click', showLuckRouletteScreen);
            document.getElementById('premiumBtn').addEventListener('click', showPremiumScreen);
        }
        
        // Показать уведомление
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.animation = 'none';
            void notification.offsetWidth; // Trigger reflow
            notification.style.animation = 'fadeInOut 3s';
        }
        
        // Обновление отображения баланса
        function updateBalanceDisplay() {
            document.getElementById('energyBalance').textContent = formatNumber(userData.energy);
            document.getElementById('gammaBalance').textContent = formatNumber(userData.gamma);
            document.getElementById('tonBalance').textContent = formatNumber(userData.ton);
        }
        
        // Форматирование чисел
        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
        }
        
        // Расчет производства энергии в час
        function calculateHourlyProduction() {
            let production = 0;
            
            // Солнечные батареи
            production += userData.buildings.solar.count * 
                         buildingData.solar.levelProduction[userData.buildings.solar.level];
            
            // Ветряные батареи
            production += userData.buildings.wind.count * 
                         buildingData.wind.levelProduction[userData.buildings.wind.level];
            
            // Водные батареи
            production += userData.buildings.water.count * 
                         buildingData.water.levelProduction[userData.buildings.water.level];
            
            // Премиум батареи (если есть)
            if (userData.premium.active) {
                production += userData.buildings.premium.count * 
                             buildingData.premium.levelProduction[userData.buildings.premium.level];
            }
            
            // Проверяем активные ивенты
            const activeEvent = events.find(event => event.active && event.multiplier);
            if (activeEvent) {
                production *= activeEvent.multiplier;
            }
            
            return production;
        }
        
        // Обновление производства энергии
        function updateProduction() {
            const productionPerSecond = calculateHourlyProduction() / 3600;
            userData.energy += productionPerSecond;
            
            // Обновляем отображение каждые 5 секунд
            if (Math.floor(Date.now() / 1000) % 5 === 0) {
                updateBalanceDisplay();
                
                // Если на экране город - обновляем производство
                if (currentScreen === 'city') {
                    showCityScreen();
                }
            }
        }
        
        // Проверка ивентов
        function checkEvents() {
            // В реальном приложении ивенты должны приходить с сервера
            // Здесь просто рандомно активируем ивенты для демонстрации
            
            // 10% шанс что какой-то ивент станет активным
            if (Math.random() < 0.1) {
                const randomEvent = events[Math.floor(Math.random() * events.length)];
                if (!randomEvent.active) {
                    randomEvent.active = true;
                    randomEvent.startTime = new Date().toISOString();
                    
                    showNotification(`Активный ивент: ${randomEvent.title}! ${randomEvent.description}`);
                    
                    // Через duration миллисекунд ивент закончится
                    setTimeout(() => {
                        randomEvent.active = false;
                        showNotification(`Ивент "${randomEvent.title}" завершен`);
                    }, randomEvent.duration);
                }
            }
            
            // Проверяем каждые 5 минут
            setTimeout(checkEvents, 5 * 60 * 1000);
        }
        
        // Показать экран города
        function showCityScreen() {
            currentScreen = 'city';
            updateActiveTab();
            
            const production = calculateHourlyProduction();
            
            const content = `
                <div class="fade-in">
                    <h2>Ваш город</h2>
                    <p>Общее производство: <strong>${formatNumber(Math.floor(production))} энергии/час</strong></p>
                    
                    <div class="building">
                        <div class="building-header">
                            <div class="building-name">Солнечные батареи</div>
                            <div class="building-level">Ур. ${userData.buildings.solar.level}</div>
                        </div>
                        <div class="building-production">
                            ${userData.buildings.solar.count} шт. - ${formatNumber(userData.buildings.solar.count * buildingData.solar.levelProduction[userData.buildings.solar.level])} э/ч
                        </div>
                        <button class="building-upgrade" onclick="upgradeBuilding('solar')" ${userData.buildings.solar.level >= 4 || getBuildingUpgradePrice('solar') > userData.gamma ? 'disabled' : ''}>
                            Улучшить (${formatNumber(getBuildingUpgradePrice('solar'))} γ)
                        </button>
                    </div>
                    
                    <div class="building">
                        <div class="building-header">
                            <div class="building-name">Воздушные батареи</div>
                            <div class="building-level">Ур. ${userData.buildings.wind.level}</div>
                        </div>
                        <div class="building-production">
                            ${userData.buildings.wind.count} шт. - ${formatNumber(userData.buildings.wind.count * buildingData.wind.levelProduction[userData.buildings.wind.level])} э/ч
                        </div>
                        <button class="building-upgrade" onclick="upgradeBuilding('wind')" ${userData.buildings.wind.level >= 4 || getBuildingUpgradePrice('wind') > userData.gamma ? 'disabled' : ''}>
                            Улучшить (${formatNumber(getBuildingUpgradePrice('wind'))} γ)
                        </button>
                    </div>
                    
                    <div class="building">
                        <div class="building-header">
                            <div class="building-name">Водные батареи</div>
                            <div class="building-level">Ур. ${userData.buildings.water.level}</div>
                        </div>
                        <div class="building-production">
                            ${userData.buildings.water.count} шт. - ${formatNumber(userData.buildings.water.count * buildingData.water.levelProduction[userData.buildings.water.level])} э/ч
                        </div>
                        <button class="building-upgrade" onclick="upgradeBuilding('water')" ${userData.buildings.water.level >= 4 || getBuildingUpgradePrice('water') > userData.gamma ? 'disabled' : ''}>
                            Улучшить (${formatNumber(getBuildingUpgradePrice('water'))} γ)
                        </button>
                    </div>
                    
                    ${userData.premium.active ? `
                    <div class="building">
                        <div class="building-header">
                            <div class="building-name">Квантовые батареи</div>
                            <div class="building-level">Ур. ${userData.buildings.premium.level}</div>
                        </div>
                        <div class="building-production">
                            ${userData.buildings.premium.count} шт. - ${formatNumber(userData.buildings.premium.count * buildingData.premium.levelProduction[userData.buildings.premium.level])} э/ч
                        </div>
                        <button class="building-upgrade" onclick="upgradeBuilding('premium')" ${userData.buildings.premium.level >= 4 || getBuildingUpgradePrice('premium') > userData.gamma ? 'disabled' : ''}>
                            Улучшить (${formatNumber(getBuildingUpgradePrice('premium'))} γ)
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
        }
        
        // Получить цену улучшения здания
        function getBuildingUpgradePrice(type) {
            const currentLevel = userData.buildings[type].level;
            if (currentLevel >= buildingData[type].levelPrices.length - 1) {
                return Infinity;
            }
            return buildingData[type].levelPrices[currentLevel + 1];
        }
        
        // Улучшить здание
        function upgradeBuilding(type) {
            const upgradePrice = getBuildingUpgradePrice(type);
            
            if (userData.gamma >= upgradePrice) {
                userData.gamma -= upgradePrice;
                userData.buildings[type].level++;
                
                showNotification(`${buildingData[type].name} улучшены до уровня ${userData.buildings[type].level + 1}!`);
                saveUserData();
                updateBalanceDisplay();
                showCityScreen();
            } else {
                showNotification(`Недостаточно Gamma Coin для улучшения!`);
            }
        }
        
        // Показать экран магазина
        function showShopScreen() {
            currentScreen = 'shop';
            updateActiveTab();
            
            const content = `
                <div class="slide-in-left">
                    <h2>Магазин</h2>
                    <p>Приобретайте здания для увеличения производства энергии</p>
                    
                    <div class="shop-item">
                        <div class="shop-item-header">
                            <span>Солнечная батарея</span>
                            <span class="shop-item-price">${buildingData.solar.basePrice} γ</span>
                        </div>
                        <div class="shop-item-desc">
                            Производство: ${buildingData.solar.baseProduction} энергии/час
                        </div>
                        <button class="shop-item-btn" onclick="buyBuilding('solar')" ${userData.gamma >= buildingData.solar.basePrice ? '' : 'disabled'}>
                            Купить
                        </button>
                    </div>
                    
                    <div class="shop-item">
                        <div class="shop-item-header">
                            <span>Воздушная батарея</span>
                            <span class="shop-item-price">${buildingData.wind.basePrice} γ</span>
                        </div>
                        <div class="shop-item-desc">
                            Производство: ${buildingData.wind.baseProduction} энергии/час
                        </div>
                        <button class="shop-item-btn" onclick="buyBuilding('wind')" ${userData.gamma >= buildingData.wind.basePrice ? '' : 'disabled'}>
                            Купить
                        </button>
                    </div>
                    
                    <div class="shop-item">
                        <div class="shop-item-header">
                            <span>Водная батарея</span>
                            <span class="shop-item-price">${buildingData.water.basePrice} γ</span>
                        </div>
                        <div class="shop-item-desc">
                            Производство: ${buildingData.water.baseProduction} энергии/час
                        </div>
                        <button class="shop-item-btn" onclick="buyBuilding('water')" ${userData.gamma >= buildingData.water.basePrice ? '' : 'disabled'}>
                            Купить
                        </button>
                    </div>
                    
                    ${userData.premium.active ? `
                    <div class="shop-item">
                        <div class="shop-item-header">
                            <span>Квантовая батарея</span>
                            <span class="shop-item-price">${buildingData.premium.basePrice} γ</span>
                        </div>
                        <div class="shop-item-desc">
                            Только для премиум игроков. Производство: ${buildingData.premium.baseProduction} энергии/час
                        </div>
                        <button class="shop-item-btn" onclick="buyBuilding('premium')" ${userData.gamma >= buildingData.premium.basePrice ? '' : 'disabled'}>
                            Купить
                        </button>
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
        }
        
        // Купить здание
        function buyBuilding(type) {
            const price = buildingData[type].basePrice;
            
            if (userData.gamma >= price) {
                userData.gamma -= price;
                userData.buildings[type].count++;
                
                showNotification(`Вы приобрели ${buildingData[type].name}!`);
                saveUserData();
                updateBalanceDisplay();
                showShopScreen();
            } else {
                showNotification(`Недостаточно Gamma Coin для покупки!`);
            }
        }
        
        // Показать экран ивентов
        function showEventsScreen() {
            currentScreen = 'events';
            updateActiveTab();
            
            let activeEvents = events.filter(event => event.active);
            let inactiveEvents = events.filter(event => !event.active);
            
            let activeContent = '';
            if (activeEvents.length > 0) {
                activeContent = `
                    <h3>Активные ивенты</h3>
                    ${activeEvents.map(event => `
                        <div class="event-card">
                            <div class="event-title">${event.title}</div>
                            <div class="event-desc">${event.description}</div>
                            <div class="event-reward">Награда: ${event.reward}</div>
                        </div>
                    `).join('')}
                `;
            }
            
            let inactiveContent = '';
            if (inactiveEvents.length > 0) {
                inactiveContent = `
                    <h3>Предстоящие ивенты</h3>
                    ${inactiveEvents.map(event => `
                        <div class="event-card">
                            <div class="event-title">${event.title}</div>
                            <div class="event-desc">${event.description}</div>
                            <div class="event-reward">Награда: ${event.reward}</div>
                        </div>
                    `).join('')}
                `;
            }
            
            const content = `
                <div class="slide-in-left">
                    <h2>Ивенты</h2>
                    ${activeEvents.length > 0 ? activeContent : '<p>Сейчас нет активных ивентов</p>'}
                    ${inactiveEvents.length > 0 ? inactiveContent : ''}
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
        }
        
        // Показать экран лидерборда
        function showLeaderboardScreen() {
            currentScreen = 'leaderboard';
            updateActiveTab();
            
            // Заглушка - в реальном приложении данные должны приходить с сервера
            if (leaderboard.length === 0) {
                // Генерируем тестовые данные
                leaderboard = [
                    { id: 1, name: 'Игрок 1', energy: 15000000, gamma: 500000, ton: 200 },
                    { id: 2, name: 'Игрок 2', energy: 12000000, gamma: 450000, ton: 180 },
                    { id: 3, name: 'Игрок 3', energy: 10000000, gamma: 400000, ton: 150 },
                    { id: 4, name: 'Игрок 4', energy: 9000000, gamma: 350000, ton: 120 },
                    { id: 5, name: 'Игрок 5', energy: 8000000, gamma: 300000, ton: 100 },
                    { id: 6, name: 'Игрок 6', energy: 7000000, gamma: 250000, ton: 80 },
                    { id: 7, name: 'Игрок 7', energy: 6000000, gamma: 200000, ton: 60 },
                    { id: 8, name: 'Игрок 8', energy: 5000000, gamma: 150000, ton: 40 },
                    { id: 9, name: 'Игрок 9', energy: 4000000, gamma: 100000, ton: 20 },
                    { id: 10, name: 'Игрок 10', energy: 3000000, gamma: 50000, ton: 10 }
                ];
            }
            
            // Добавляем текущего пользователя, если его нет в топ-10
            const userInLeaderboard = leaderboard.find(u => u.id === tg.initDataUnsafe.user?.id);
            if (!userInLeaderboard) {
                leaderboard.push({
                    id: tg.initDataUnsafe.user?.id,
                    name: tg.initDataUnsafe.user?.first_name || 'Вы',
                    energy: userData.energy,
                    gamma: userData.gamma,
                    ton: userData.ton
                });
            }
            
            // Сортируем по энергии
            leaderboard.sort((a, b) => b.energy - a.energy);
            
            const content = `
                <div class="slide-in-right">
                    <h2>Лидерборд</h2>
                    <p>Топ игроков по количеству энергии</p>
                    
                    <div class="leaderboard">
                        ${leaderboard.slice(0, 10).map((user, index) => `
                            <div class="leaderboard-item ${user.id === tg.initDataUnsafe.user?.id ? 'premium-card' : ''}">
                                <div class="leaderboard-position">${index + 1}</div>
                                <div class="leaderboard-name">${user.name}</div>
                                <div class="leaderboard-value">${formatNumber(user.energy)}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
        }
        
        // Показать экран обмена
        function showExchangeScreen() {
            currentScreen = 'exchange';
            updateActiveTab();
            
            const content = `
                <div class="slide-in-right">
                    <h2>Обмен валют</h2>
                    
                    <div class="exchange-container">
                        <div class="exchange-card">
                            <div class="exchange-title">Обменять энергию на Gamma Coin</div>
                            <p>Курс: ${exchangeRates.energyToGamma} энергии = ${exchangeRates.gammaToEnergy} γ</p>
                            <input type="number" id="energyToGammaAmount" class="exchange-input" placeholder="Количество энергии" min="10000" step="10000">
                            <button class="exchange-btn" onclick="exchangeEnergyToGamma()">Обменять</button>
                        </div>
                        
                        <div class="exchange-card">
                            <div class="exchange-title">Обменять Gamma Coin на TON</div>
                            <p>Курс: ${formatNumber(exchangeRates.gammaToTon)} γ = ${exchangeRates.gammaToTonRate} TON</p>
                            <input type="number" id="gammaToTonAmount" class="exchange-input" placeholder="Количество Gamma Coin" min="10000000" step="10000000">
                            <button class="exchange-btn" onclick="exchangeGammaToTon()">Обменять</button>
                        </div>
                        
                        <div class="exchange-card">
                            <div class="exchange-title">Обменять TON на Gamma Coin</div>
                            <p>Курс: 1 TON = ${exchangeRates.tonToGamma} γ</p>
                            <input type="number" id="tonToGammaAmount" class="exchange-input" placeholder="Количество TON" min="1" max="100" step="1">
                            <button class="exchange-btn" onclick="exchangeTonToGamma()">Обменять</button>
                        </div>
                        
                        <div class="exchange-card">
                            <div class="exchange-title">Пополнить баланс TON</div>
                            <input type="number" id="depositAmount" class="exchange-input" placeholder="Количество TON (1-100)" min="${limits.depositMin}" max="${limits.depositMax}" step="1">
                            <button class="exchange-btn" onclick="depositTon()">Пополнить</button>
                            <p style="font-size: 12px; text-align: center; margin-top: 5px;">Пополнение происходит через Telegram Payments</p>
                        </div>
                        
                        <div class="exchange-card">
                            <div class="exchange-title">Вывести TON</div>
                            <input type="number" id="withdrawAmount" class="exchange-input" placeholder="Количество TON" min="${limits.withdrawMin}" step="1">
                            <input type="text" id="withdrawWallet" class="exchange-input" placeholder="TON кошелек">
                            <button class="exchange-btn" onclick="withdrawTon()" ${canWithdraw() ? '' : 'disabled'}>
                                ${canWithdraw() ? 'Вывести' : `Вывод доступен через ${daysLeftForWithdraw()} дн.`}
                            </button>
                            <div class="withdraw-warning">
                                Вывод доступен только через ${limits.withdrawDays} дней после регистрации
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
        }
        
        // Обменять энергию на Gamma Coin
        function exchangeEnergyToGamma() {
            const amount = parseInt(document.getElementById('energyToGammaAmount').value);
            
            if (isNaN(amount) || amount < exchangeRates.energyToGamma) {
                showNotification(`Минимальная сумма обмена: ${exchangeRates.energyToGamma} энергии`);
                return;
            }
            
            if (userData.energy >= amount) {
                const gammaAmount = Math.floor(amount / exchangeRates.energyToGamma * exchangeRates.gammaToEnergy);
                userData.energy -= amount;
                userData.gamma += gammaAmount;
                
                showNotification(`Вы обменяли ${amount} энергии на ${gammaAmount} Gamma Coin!`);
                saveUserData();
                updateBalanceDisplay();
            } else {
                showNotification(`Недостаточно энергии для обмена!`);
            }
        }
        
        // Обменять Gamma Coin на TON
        function exchangeGammaToTon() {
            const amount = parseInt(document.getElementById('gammaToTonAmount').value);
            
            if (isNaN(amount) || amount < exchangeRates.gammaToTon) {
                showNotification(`Минимальная сумма обмена: ${formatNumber(exchangeRates.gammaToTon)} Gamma Coin`);
                return;
            }
            
            if (userData.gamma >= amount) {
                const tonAmount = Math.floor(amount / exchangeRates.gammaToTon * exchangeRates.gammaToTonRate);
                userData.gamma -= amount;
                userData.ton += tonAmount;
                
                showNotification(`Вы обменяли ${formatNumber(amount)} Gamma Coin на ${tonAmount} TON!`);
                saveUserData();
                updateBalanceDisplay();
            } else {
                showNotification(`Недостаточно Gamma Coin для обмена!`);
            }
        }
        
        // Обменять TON на Gamma Coin
        function exchangeTonToGamma() {
            const amount = parseInt(document.getElementById('tonToGammaAmount').value);
            
            if (isNaN(amount) || amount < 1) {
                showNotification(`Минимальная сумма обмена: 1 TON`);
                return;
            }
            
            if (userData.ton >= amount) {
                const gammaAmount = amount * exchangeRates.tonToGamma;
                userData.ton -= amount;
                userData.gamma += gammaAmount;
                
                showNotification(`Вы обменяли ${amount} TON на ${formatNumber(gammaAmount)} Gamma Coin!`);
                saveUserData();
                updateBalanceDisplay();
            } else {
                showNotification(`Недостаточно TON для обмена!`);
            }
        }
        
        // Пополнить баланс TON
        function depositTon() {
            const amount = parseInt(document.getElementById('depositAmount').value);
            
            if (isNaN(amount) || amount < limits.depositMin || amount > limits.depositMax) {
                showNotification(`Сумма пополнения должна быть от ${limits.depositMin} до ${limits.depositMax} TON`);
                return;
            }
            
            // В реальном приложении здесь должен быть вызов Telegram Payments
            // Это пример реализации
            
            const paymentData = {
                title: "Пополнение баланса",
                description: `Покупка ${amount} TON`,
                payload: JSON.stringify({ userId: tg.initDataUnsafe.user?.id, type: "deposit", amount }),
                currency: "TON",
                prices: [
                    { label: `${amount} TON`, amount: amount * 1000000000 } // TON в нанотонах
                ],
                provider_token: "YOUR_PROVIDER_TOKEN" // Нужно получить у платежного провайдера
            };
            
            // В демо-версии просто добавляем TON на баланс
            userData.ton += amount;
            showNotification(`Ваш баланс пополнен на ${amount} TON (демо-режим)`);
            saveUserData();
            updateBalanceDisplay();
            
            // В реальном приложении:
            // tg.sendData(JSON.stringify(paymentData));
            // и обработка ответа от платежной системы
        }
        
        // Вывести TON
        function withdrawTon() {
            if (!canWithdraw()) {
                showNotification(`Вывод будет доступен через ${daysLeftForWithdraw()} дней`);
                return;
            }
            
            const amount = parseInt(document.getElementById('withdrawAmount').value);
            const wallet = document.getElementById('withdrawWallet').value.trim();
            
            if (isNaN(amount) || amount < limits.withdrawMin) {
                showNotification(`Минимальная сумма вывода: ${limits.withdrawMin} TON`);
                return;
            }
            
            if (!wallet || !isValidTonWallet(wallet)) {
                showNotification(`Укажите корректный TON кошелек`);
                return;
            }
            
            if (userData.ton >= amount) {
                // В реальном приложении здесь должен быть запрос на сервер для вывода
                // Это пример реализации
                
                // Отправляем запрос на вывод
                fetch('https://your-server.com/withdraw', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        userId: tg.initDataUnsafe.user?.id,
                        amount,
                        wallet,
                        signature: '...' // Подпись для безопасности
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        userData.ton -= amount;
                        showNotification(`Запрос на вывод ${amount} TON отправлен!`);
                        saveUserData();
                        updateBalanceDisplay();
                    } else {
                        showNotification(`Ошибка вывода: ${data.message}`);
                    }
                })
                .catch(error => {
                    showNotification(`Ошибка соединения с сервером`);
                    console.error('Withdraw error:', error);
                });
                
                // В демо-версии просто показываем сообщение
                showNotification(`Запрос на вывод ${amount} TON на кошелек ${wallet} отправлен (демо-режим)`);
            } else {
                showNotification(`Недостаточно TON для вывода!`);
            }
        }
        
        // Проверить возможность вывода
        function canWithdraw() {
            const joinDate = new Date(userData.joinDate);
            const now = new Date();
            const diffTime = now - joinDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            
            return diffDays >= limits.withdrawDays;
        }
        
        // Сколько дней осталось до возможности вывода
        function daysLeftForWithdraw() {
            const joinDate = new Date(userData.joinDate);
            const now = new Date();
            const diffTime = now - joinDate;
            const diffDays = diffTime / (1000 * 60 * 60 * 24);
            
            return Math.max(0, Math.ceil(limits.withdrawDays - diffDays));
        }
        
        // Проверить валидность TON кошелька (упрощенная версия)
        function isValidTonWallet(wallet) {
            return wallet.length >= 48 && (wallet.startsWith('EQ') || wallet.startsWith('UQ'));
        }
        
        // Показать экран рулетки энергии
        function showEnergyRouletteScreen() {
            const now = new Date();
            const lastSpin = userData.lastEnergyRoulette ? new Date(userData.lastEnergyRoulette) : null;
            const canSpin = !lastSpin || (now - lastSpin) >= 24 * 60 * 60 * 1000;
            
            const content = `
                <div class="roulette-container fade-in">
                    <h2>Рулетка энергии</h2>
                    <p>Крутите рулетку и получайте от 100 до 2000 энергии раз в сутки!</p>
                    
                    <div class="roulette-wheel" id="energyWheel"></div>
                    <div class="roulette-pointer"></div>
                    
                    <button class="spin-btn" id="spinEnergyBtn" ${canSpin ? '' : 'disabled'}>
                        ${canSpin ? 'Крутить' : `До следующего кручения: ${timeUntilNextSpin()}`}
                    </button>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
            
            if (canSpin) {
                document.getElementById('spinEnergyBtn').addEventListener('click', spinEnergyRoulette);
            }
        }
        
        // Крутить рулетку энергии
        function spinEnergyRoulette() {
            const btn = document.getElementById('spinEnergyBtn');
            btn.disabled = true;
            
            const wheel = document.getElementById('energyWheel');
            const spinDuration = 3000; // 3 секунды
            const spins = 5; // Количество полных оборотов
            
            // Анимация вращения
            wheel.style.transform = `rotate(${spins * 360 + Math.floor(Math.random() * 360)}deg)`;
            wheel.style.transition = `transform ${spinDuration}ms cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
            
            // После завершения вращения
            setTimeout(() => {
                const reward = Math.floor(100 + Math.random() * 1900); // От 100 до 2000
                userData.energy += reward;
                userData.lastEnergyRoulette = new Date().toISOString();
                
                showNotification(`Поздравляем! Вы выиграли ${reward} энергии!`);
                saveUserData();
                updateBalanceDisplay();
                
                // Обновляем кнопку
                btn.textContent = `До следующего кручения: 24:00:00`;
                
                // Таймер обратного отсчета
                let hours = 23;
                let minutes = 59;
                let seconds = 59;
                
                const countdown = setInterval(() => {
                    seconds--;
                    if (seconds < 0) {
                        seconds = 59;
                        minutes--;
                    }
                    if (minutes < 0) {
                        minutes = 59;
                        hours--;
                    }
                    if (hours < 0) {
                        clearInterval(countdown);
                        btn.disabled = false;
                        btn.textContent = 'Крутить';
                    } else {
                        btn.textContent = `До следующего кручения: ${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }, 1000);
            }, spinDuration);
        }
        
        // Время до следующего кручения рулетки
        function timeUntilNextSpin() {
            if (!userData.lastEnergyRoulette) return "00:00:00";
            
            const lastSpin = new Date(userData.lastEnergyRoulette);
            const now = new Date();
            const nextSpin = new Date(lastSpin.getTime() + 24 * 60 * 60 * 1000);
            
            if (now >= nextSpin) return "00:00:00";
            
            const diff = nextSpin - now;
            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diff % (1000 * 60)) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Показать экран рулетки удачи
        function showLuckRouletteScreen() {
            const content = `
                <div class="roulette-container fade-in">
                    <h2>Рулетка удачи</h2>
                    <p>Крутите рулетку за 1 TON и получайте от 0.5 до 5 TON!</p>
                    
                    <div class="roulette-wheel" id="luckWheel"></div>
                    <div class="roulette-pointer"></div>
                    
                    <button class="spin-btn" id="spinLuckBtn" ${userData.ton >= 1 ? '' : 'disabled'}>
                        ${userData.ton >= 1 ? 'Крутить (1 TON)' : 'Недостаточно TON'}
                    </button>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
            
            if (userData.ton >= 1) {
                document.getElementById('spinLuckBtn').addEventListener('click', spinLuckRoulette);
            }
        }
        
        // Крутить рулетку удачи
        function spinLuckRoulette() {
            const btn = document.getElementById('spinLuckBtn');
            btn.disabled = true;
            
            const wheel = document.getElementById('luckWheel');
            const spinDuration = 3000; // 3 секунды
            const spins = 5; // Количество полных оборотов
            
            // Анимация вращения
            wheel.style.transform = `rotate(${spins * 360 + Math.floor(Math.random() * 360)}deg)`;
            wheel.style.transition = `transform ${spinDuration}ms cubic-bezier(0.17, 0.67, 0.12, 0.99)`;
            
            // После завершения вращения
            setTimeout(() => {
                userData.ton -= 1; // Списываем 1 TON за попытку
                
                // Проверяем активные ивенты для увеличения шансов
                const activeEvent = events.find(event => event.active && event.luckMultiplier);
                const multiplier = activeEvent ? activeEvent.luckMultiplier : 1;
                
                // Вычисляем выигрыш с учетом множителя ивента
                const baseReward = 0.5 + Math.random() * 4.5; // От 0.5 до 5
                const reward = parseFloat((baseReward * multiplier).toFixed(2));
                
                userData.ton += reward;
                userData.lastLuckRoulette = new Date().toISOString();
                
                showNotification(`Поздравляем! Вы выиграли ${reward} TON!`);
                saveUserData();
                updateBalanceDisplay();
                
                // Обновляем кнопку
                btn.disabled = userData.ton < 1;
                btn.textContent = userData.ton >= 1 ? 'Крутить (1 TON)' : 'Недостаточно TON';
            }, spinDuration);
        }
        
        // Показать экран премиума
        function showPremiumScreen() {
            const content = `
                <div class="slide-in-right">
                    <h2>Премиум статус</h2>
                    <p>Откройте дополнительные возможности и увеличьте свой доход!</p>
                    
                    <div class="premium-card">
                        <div class="premium-title">
                            Премиум на месяц
                            ${userData.premium.active && !userData.premium.permanent ? '<span class="premium-badge">АКТИВЕН</span>' : ''}
                        </div>
                        <div class="premium-price">${premiumOffers.monthly.price} TON</div>
                        <div class="premium-benefits">
                            <div class="premium-benefit"><i class="fas fa-check"></i> Доступ к квантовым батареям</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> +10% к производству энергии</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> Ежедневный бонус Gamma Coin</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> Специальный значок в лидерборде</div>
                        </div>
                        <button class="premium-btn" onclick="buyPremium('monthly')" ${userData.ton >= premiumOffers.monthly.price && !userData.premium.permanent ? '' : 'disabled'}>
                            ${userData.premium.permanent ? 'УЖЕ АКТИВЕН' : (userData.premium.active ? 'ПРОДЛИТЬ' : 'ПРИОБРЕСТИ')}
                        </button>
                    </div>
                    
                    <div class="premium-card">
                        <div class="premium-title">
                            Премиум навсегда
                            ${userData.premium.permanent ? '<span class="premium-badge">АКТИВЕН</span>' : ''}
                        </div>
                        <div class="premium-price">${premiumOffers.permanent.price} TON</div>
                        <div class="premium-benefits">
                            <div class="premium-benefit"><i class="fas fa-check"></i> Все преимущества месячного премиума</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> +20% к производству энергии</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> Ежедневный бонус x2</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> Эксклюзивный значок в профиле</div>
                            <div class="premium-benefit"><i class="fas fa-check"></i> Доступ к эксклюзивным ивентам</div>
                        </div>
                        <button class="premium-btn" onclick="buyPremium('permanent')" ${userData.ton >= premiumOffers.permanent.price && !userData.premium.permanent ? '' : 'disabled'}>
                            ${userData.premium.permanent ? 'УЖЕ АКТИВЕН' : 'ПРИОБРЕСТИ'}
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('mainContent').innerHTML = content;
        }
        
        // Купить премиум
        function buyPremium(type) {
            const offer = premiumOffers[type];
            
            if (userData.ton >= offer.price) {
                userData.ton -= offer.price;
                
                if (type === 'monthly') {
                    const now = new Date();
                    const expires = new Date(now.getTime() + offer.duration);
                    
                    userData.premium.active = true;
                    userData.premium.expires = expires.toISOString();
                    userData.premium.permanent = false;
                    
                    showNotification(`Премиум статус активирован до ${expires.toLocaleDateString()}`);
                } else {
                    userData.premium.active = true;
                    userData.premium.expires = null;
                    userData.premium.permanent = true;
                    
                    showNotification(`Премиум статус активирован навсегда!`);
                }
                
                saveUserData();
                updateBalanceDisplay();
                showPremiumScreen();
            } else {
                showNotification(`Недостаточно TON для покупки премиума!`);
            }
        }
        
        // Обновить активную вкладку в нижнем меню
        function updateActiveTab() {
            document.querySelectorAll('.footer-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            switch(currentScreen) {
                case 'events':
                    document.getElementById('eventsBtn').classList.add('active');
                    break;
                case 'shop':
                    document.getElementById('shopBtn').classList.add('active');
                    break;
                case 'leaderboard':
                    document.getElementById('leaderboardBtn').classList.add('active');
                    break;
                case 'exchange':
                    document.getElementById('exchangeBtn').classList.add('active');
                    break;
            }
        }
        
        // Глобальные функции для вызова из HTML
        window.buyBuilding = buyBuilding;
        window.upgradeBuilding = upgradeBuilding;
        window.exchangeEnergyToGamma = exchangeEnergyToGamma;
        window.exchangeGammaToTon = exchangeGammaToTon;
        window.exchangeTonToGamma = exchangeTonToGamma;
        window.depositTon = depositTon;
        window.withdrawTon = withdrawTon;
        window.spinEnergyRoulette = spinEnergyRoulette;
        window.spinLuckRoulette = spinLuckRoulette;
        window.buyPremium = buyPremium;
    </script>
</body>
</html>
