<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Empire</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
            transition: all 0.3s ease;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 100%;
            padding: 10px;
            position: relative;
            min-height: 100vh;
            padding-bottom: 80px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            position: relative;
        }
        
        .currency-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .currency-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .round-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            font-size: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            border: none;
            outline: none;
            transition: transform 0.2s;
        }
        
        .round-button:active {
            transform: scale(0.95);
        }
        
        .main-screen {
            margin-top: 20px;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            min-height: 300px;
            position: relative;
            overflow: hidden;
        }
        
        .nav-buttons {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-around;
            padding: 10px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        
        .nav-button {
            padding: 10px 15px;
            border-radius: 20px;
            background: linear-gradient(135deg, #6e8efb, #a777e3);
            color: white;
            border: none;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s;
            flex: 1;
            margin: 0 5px;
            text-align: center;
            max-width: 20%;
        }
        
        .nav-button:active {
            transform: scale(0.95);
        }
        
        .nav-button.city {
            flex: 1.5;
            max-width: 30%;
        }
        
        .building {
            display: flex;
            align-items: center;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 10px;
            margin-bottom: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .building-icon {
            width: 50px;
            height: 50px;
            border-radius: 10px;
            background: #ddd;
            margin-right: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        
        .building-info {
            flex: 1;
        }
        
        .building-name {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .building-stats {
            font-size: 12px;
            color: #666;
        }
        
        .building-actions {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .action-button {
            padding: 5px 10px;
            border-radius: 5px;
            border: none;
            background: #6e8efb;
            color: white;
            font-size: 12px;
            cursor: pointer;
        }
        
        .action-button.upgrade {
            background: #4CAF50;
        }
        
        .action-button.buy {
            background: #FF9800;
        }
        
        .premium-badge {
            background: gold;
            color: black;
            padding: 2px 5px;
            border-radius: 5px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 5px;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .modal.active {
            opacity: 1;
            pointer-events: all;
        }
        
        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 15px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s;
        }
        
        .modal.active .modal-content {
            transform: translateY(0);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 20px;
            font-weight: bold;
        }
        
        .close-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }
        
        .roulette-container {
            text-align: center;
            padding: 20px;
        }
        
        .roulette-wheel {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border-radius: 50%;
            background: conic-gradient(
                red, orange, yellow, green, blue, indigo, violet
            );
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .roulette-center {
            width: 30px;
            height: 30px;
            background: white;
            border-radius: 50%;
            position: absolute;
            z-index: 2;
        }
        
        .roulette-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 20px solid red;
            z-index: 3;
        }
        
        .spin-button {
            padding: 10px 20px;
            background: #FF5722;
            color: white;
            border: none;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }
        
        .leaderboard {
            width: 100%;
            border-collapse: collapse;
        }
        
        .leaderboard th, .leaderboard td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        .leaderboard th {
            background: #f2f2f2;
        }
        
        .leaderboard tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        .leaderboard tr:hover {
            background: #f1f1f1;
        }
        
        .user-rank {
            font-weight: bold;
            color: #6e8efb;
        }
        
        .exchange-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .exchange-input {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        
        .exchange-button {
            padding: 10px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .premium-option {
            padding: 15px;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border-radius: 10px;
            margin-bottom: 10px;
            color: black;
        }
        
        .premium-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .premium-price {
            font-size: 14px;
        }
        
        .buy-premium {
            padding: 5px 10px;
            background: black;
            color: gold;
            border: none;
            border-radius: 5px;
            margin-top: 5px;
            cursor: pointer;
        }
        
        .city-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .city-building {
            background: #f9f9f9;
            border-radius: 10px;
            padding: 10px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        
        .city-building-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 5px;
            border-radius: 10px;
            background: #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
        }
        
        .city-building-name {
            font-weight: bold;
            font-size: 12px;
        }
        
        .city-building-count {
            font-size: 10px;
            color: #666;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .notification.show {
            opacity: 1;
        }
        
        .withdraw-info {
            font-size: 12px;
            color: #666;
            margin-top: 10px;
        }
        
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Анимации */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); }
            to { transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s forwards;
        }
        
        .slide-up {
            animation: slideUp 0.3s forwards;
        }
        
        .pulse {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="currency-display">
                <div class="currency-item">
                    <span>⚡</span>
                    <span id="energy-balance">0</span>
                </div>
                <div class="currency-item">
                    <span>Γ</span>
                    <span id="gamma-balance">0</span>
                </div>
                <div class="currency-item">
                    <span>💎</span>
                    <span id="ton-balance">0</span>
                </div>
            </div>
            
            <button class="round-button" id="premium-button">👑</button>
            <button class="round-button" id="luck-roulette-button">🍀</button>
            <button class="round-button" id="energy-roulette-button">🎡</button>
        </div>
        
        <div class="main-screen" id="main-screen">
            <!-- Контент будет динамически меняться -->
            <div class="city-grid" id="city-view">
                <!-- Здания города будут здесь -->
            </div>
        </div>
        
        <div class="nav-buttons">
            <button class="nav-button" id="events-button">Ивенты</button>
            <button class="nav-button" id="shop-button">Магазин</button>
            <button class="nav-button city" id="city-button">Город</button>
            <button class="nav-button" id="leaderboard-button">Топ</button>
            <button class="nav-button" id="exchange-button">Обмен</button>
        </div>
    </div>
    
    <!-- Модальные окна -->
    <div class="modal" id="shop-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Магазин</div>
                <button class="close-button" id="close-shop">&times;</button>
            </div>
            <div id="shop-items">
                <!-- Товары магазина будут здесь -->
            </div>
        </div>
    </div>
    
    <div class="modal" id="events-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Ивенты</div>
                <button class="close-button" id="close-events">&times;</button>
            </div>
            <p>Скоро появятся интересные ивенты!</p>
        </div>
    </div>
    
    <div class="modal" id="leaderboard-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Топ игроков</div>
                <button class="close-button" id="close-leaderboard">&times;</button>
            </div>
            <table class="leaderboard">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Игрок</th>
                        <th>Энергия</th>
                        <th>Gamma</th>
                        <th>TON</th>
                    </tr>
                </thead>
                <tbody id="leaderboard-body">
                    <!-- Данные лидерборда будут здесь -->
                </tbody>
            </table>
        </div>
    </div>
    
    <div class="modal" id="exchange-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Обмен</div>
                <button class="close-button" id="close-exchange">&times;</button>
            </div>
            <div class="exchange-tabs">
                <button class="exchange-tab active" data-tab="convert">Конвертация</button>
                <button class="exchange-tab" data-tab="deposit">Пополнение</button>
                <button class="exchange-tab" data-tab="withdraw">Вывод</button>
            </div>
            
            <div class="exchange-tab-content active" id="convert-tab">
                <div class="exchange-form">
                    <select class="exchange-input" id="exchange-from">
                        <option value="energy">⚡ Энергия</option>
                        <option value="gamma">Γ Gamma</option>
                        <option value="ton">💎 TON</option>
                    </select>
                    <input type="number" class="exchange-input" id="exchange-amount" placeholder="Количество">
                    <select class="exchange-input" id="exchange-to">
                        <option value="gamma">Γ Gamma</option>
                        <option value="ton">💎 TON</option>
                        <option value="energy">⚡ Энергия</option>
                    </select>
                    <button class="exchange-button" id="exchange-submit">Обменять</button>
                </div>
            </div>
            
            <div class="exchange-tab-content" id="deposit-tab">
                <div class="exchange-form">
                    <input type="number" class="exchange-input" id="deposit-amount" placeholder="TON (1-100)" min="1" max="100">
                    <button class="exchange-button" id="deposit-submit">Пополнить</button>
                    <p>Пополнение от 1 до 100 TON</p>
                </div>
            </div>
            
            <div class="exchange-tab-content" id="withdraw-tab">
                <div class="exchange-form">
                    <input type="number" class="exchange-input" id="withdraw-amount" placeholder="TON">
                    <input type="text" class="exchange-input" id="withdraw-address" placeholder="TON кошелек">
                    <button class="exchange-button" id="withdraw-submit">Вывести</button>
                    <p class="withdraw-info">Вывод доступен только через 100 дней после регистрации. Комиссия: 5%</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal" id="energy-roulette-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Рулетка энергии</div>
                <button class="close-button" id="close-energy-roulette">&times;</button>
            </div>
            <div class="roulette-container">
                <div class="roulette-wheel" id="energy-wheel">
                    <div class="roulette-center"></div>
                    <div class="roulette-pointer"></div>
                </div>
                <button class="spin-button" id="spin-energy">Крутить (1 раз в день)</button>
                <p id="energy-roulette-result"></p>
            </div>
        </div>
    </div>
    
    <div class="modal" id="luck-roulette-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Рулетка удачи</div>
                <button class="close-button" id="close-luck-roulette">&times;</button>
            </div>
            <div class="roulette-container">
                <div class="roulette-wheel" id="luck-wheel">
                    <div class="roulette-center"></div>
                    <div class="roulette-pointer"></div>
                </div>
                <button class="spin-button" id="spin-luck">Крутить (1 TON)</button>
                <p id="luck-roulette-result"></p>
            </div>
        </div>
    </div>
    
    <div class="modal" id="premium-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Премиум статус</div>
                <button class="close-button" id="close-premium">&times;</button>
            </div>
            <div class="premium-option">
                <div class="premium-title">Премиум на 1 месяц</div>
                <div class="premium-price">5 💎 TON</div>
                <button class="buy-premium" data-type="monthly">Купить</button>
            </div>
            <div class="premium-option">
                <div class="premium-title">Премиум навсегда</div>
                <div class="premium-price">30 💎 TON</div>
                <button class="buy-premium" data-type="lifetime">Купить</button>
            </div>
        </div>
    </div>
    
    <div class="notification" id="notification"></div>
    
    <div class="loading" id="loading" style="display: none;">
        <div class="spinner"></div>
    </div>
    
    <script>
        // Инициализация Telegram WebApp
        const tg = window.Telegram.WebApp;
        tg.expand();
        
        // Данные пользователя
        let userData = {
            id: tg.initDataUnsafe.user?.id || Math.floor(Math.random() * 1000000),
            username: tg.initDataUnsafe.user?.username || 'Гость',
            firstName: tg.initDataUnsafe.user?.first_name || 'Игрок',
            lastName: tg.initDataUnsafe.user?.last_name || '',
            energy: 0,
            gamma: 0,
            ton: 0,
            buildings: {
                solar: { level: 0, count: 0 },
                wind: { level: 0, count: 0 },
                water: { level: 0, count: 0 },
                premium: { level: 0, count: 0 }
            },
            premium: {
                active: false,
                type: null,
                expires: null
            },
            lastEnergyRoulette: null,
            registrationDate: new Date().toISOString(),
            lastEnergyUpdate: new Date().toISOString()
        };
        
        // Цены и параметры зданий
        const buildingData = {
            solar: {
                name: "Солнечная батарея",
                buyPrice: [7, 10, 37, 54, 107],
                income: [700, 1000, 2100, 4400, 5700],
                icon: "☀️"
            },
            wind: {
                name: "Ветряная батарея",
                buyPrice: [21, 58, 127, 256, 448],
                income: [2100, 4400, 5700, 9600, 17300],
                icon: "🌬️"
            },
            water: {
                name: "Водная батарея",
                buyPrice: [76, 148, 272, 437, 821],
                income: [5700, 9600, 17300, 26700, 48400],
                icon: "💧"
            },
            premium: {
                name: "Квантовая батарея",
                buyPrice: [1000],
                income: [10000],
                icon: "⚛️"
            }
        };
        
        // Курсы обмена
        const exchangeRates = {
            energyToGamma: 0.001, // 10000 энергии = 10 гамма
            gammaToTon: 0.0001,   // 10000 гамма = 1 тон
            tonToGamma: 10000      // 1 тон = 10000 гамма
        };
        
        // Инициализация приложения
        document.addEventListener('DOMContentLoaded', async function() {
            // Загрузка данных пользователя
            await loadUserData();
            
            // Обновление баланса
            updateBalances();
            
            // Инициализация города
            initCityView();
            
            // Инициализация магазина
            initShop();
            
            // Настройка обработчиков событий
            setupEventListeners();
            
            // Запуск автообновления энергии
            startEnergyProduction();
            
            // Загрузка лидерборда
            loadLeaderboard();
            
            // Проверка премиум статуса
            checkPremiumStatus();
        });
        
        // Загрузка данных пользователя
        async function loadUserData() {
            // В реальном приложении здесь будет запрос к серверу
            const savedData = localStorage.getItem(`userData_${userData.id}`);
            if (savedData) {
                const parsedData = JSON.parse(savedData);
                
                // Обновляем только те поля, которые есть в сохраненных данных
                for (const key in parsedData) {
                    if (userData.hasOwnProperty(key)) {
                        userData[key] = parsedData[key];
                    }
                }
                
                // Проверяем, прошло ли время с последнего обновления энергии
                const now = new Date();
                const lastUpdate = new Date(userData.lastEnergyUpdate);
                const diffHours = (now - lastUpdate) / (1000 * 60 * 60);
                
                if (diffHours > 0) {
                    // Вычисляем произведенную энергию
                    let producedEnergy = 0;
                    
                    for (const buildingType in userData.buildings) {
                        const building = userData.buildings[buildingType];
                        if (building.count > 0 && building.level > 0) {
                            const income = buildingData[buildingType].income[building.level - 1];
                            producedEnergy += income * building.count * diffHours;
                        }
                    }
                    
                    // Добавляем энергию к балансу
                    userData.energy += Math.floor(producedEnergy);
                    userData.lastEnergyUpdate = now.toISOString();
                    saveUserData();
                }
            }
        }
        
        // Сохранение данных пользователя
        async function saveUserData() {
            // В реальном приложении здесь будет запрос к серверу
            localStorage.setItem(`userData_${userData.id}`, JSON.stringify(userData));
            
            // Обновляем баланс на экране
            updateBalances();
            
            // Обновляем лидерборд
            updateLeaderboard();
        }
        
        // Обновление отображения баланса
        function updateBalances() {
            document.getElementById('energy-balance').textContent = userData.energy.toLocaleString();
            document.getElementById('gamma-balance').textContent = userData.gamma.toLocaleString();
            document.getElementById('ton-balance').textContent = userData.ton.toLocaleString();
        }
        
        // Инициализация вида города
        function initCityView() {
            const cityView = document.getElementById('city-view');
            cityView.innerHTML = '';
            
            for (const buildingType in userData.buildings) {
                const building = userData.buildings[buildingType];
                if (building.count > 0 || buildingType === 'premium') {
                    const buildingInfo = buildingData[buildingType];
                    
                    const buildingElement = document.createElement('div');
                    buildingElement.className = 'city-building';
                    
                    buildingElement.innerHTML = `
                        <div class="city-building-icon">${buildingInfo.icon}</div>
                        <div class="city-building-name">${buildingInfo.name}</div>
                        <div class="city-building-count">Уровень ${building.level} × ${building.count}</div>
                    `;
                    
                    cityView.appendChild(buildingElement);
                }
            }
            
            if (cityView.children.length === 0) {
                cityView.innerHTML = '<p>У вас пока нет зданий. Посетите магазин, чтобы купить первые здания!</p>';
            }
        }
        
        // Инициализация магазина
        function initShop() {
            const shopItems = document.getElementById('shop-items');
            shopItems.innerHTML = '';
            
            for (const buildingType in buildingData) {
                if (buildingType === 'premium' && !userData.premium.active) continue;
                
                const building = buildingData[buildingType];
                const userBuilding = userData.buildings[buildingType];
                const currentLevel = userBuilding.level;
                const nextLevel = currentLevel + 1;
                
                // Проверяем, можно ли улучшить здание
                const canUpgrade = nextLevel <= building.buyPrice.length;
                const canBuy = userBuilding.count === 0 && currentLevel === 0;
                
                // Определяем цену в зависимости от того, покупаем или улучшаем
                let price, actionText;
                if (canBuy) {
                    price = building.buyPrice[0];
                    actionText = 'Купить';
                } else if (canUpgrade) {
                    price = building.buyPrice[nextLevel - 1];
                    actionText = 'Улучшить';
                } else {
                    price = 'Макс. ур.';
                    actionText = 'Макс.';
                }
                
                const buildingElement = document.createElement('div');
                buildingElement.className = 'building';
                
                buildingElement.innerHTML = `
                    <div class="building-icon">${building.icon}</div>
                    <div class="building-info">
                        <div class="building-name">${building.name} ${buildingType === 'premium' ? '<span class="premium-badge">PREMIUM</span>' : ''}</div>
                        <div class="building-stats">
                            Доход: ${canUpgrade ? building.income[nextLevel - 1] : building.income[currentLevel - 1]} э/ч
                            ${userBuilding.count > 0 ? `| Ур. ${currentLevel} | Кол-во: ${userBuilding.count}` : ''}
                        </div>
                    </div>
                    <div class="building-actions">
                        <button class="action-button ${canBuy ? 'buy' : 'upgrade'}" 
                                data-type="${buildingType}" 
                                data-action="${canBuy ? 'buy' : 'upgrade'}"
                                ${(!canBuy && !canUpgrade) || userData.gamma < price ? 'disabled' : ''}>
                            ${actionText} за ${price} Γ
                        </button>
                    </div>
                `;
                
                shopItems.appendChild(buildingElement);
            }
            
            // Добавляем обработчики событий для кнопок в магазине
            document.querySelectorAll('.building-actions button').forEach(button => {
                button.addEventListener('click', function() {
                    const buildingType = this.getAttribute('data-type');
                    const action = this.getAttribute('data-action');
                    
                    if (action === 'buy') {
                        buyBuilding(buildingType);
                    } else {
                        upgradeBuilding(buildingType);
                    }
                });
            });
        }
        
        // Покупка здания
        function buyBuilding(buildingType) {
            const building = buildingData[buildingType];
            const price = building.buyPrice[0];
            
            if (userData.gamma >= price) {
                userData.gamma -= price;
                userData.buildings[buildingType].count = 1;
                userData.buildings[buildingType].level = 1;
                saveUserData();
                initShop();
                initCityView();
                showNotification(`Вы купили ${building.name}!`);
            } else {
                showNotification('Недостаточно Gamma Coin!', 'error');
            }
        }
        
        // Улучшение здания
        function upgradeBuilding(buildingType) {
            const building = buildingData[buildingType];
            const currentLevel = userData.buildings[buildingType].level;
            const nextLevel = currentLevel + 1;
            
            if (nextLevel > building.buyPrice.length) {
                showNotification('Здание уже максимального уровня!', 'error');
                return;
            }
            
            const price = building.buyPrice[nextLevel - 1];
            
            if (userData.gamma >= price) {
                userData.gamma -= price;
                userData.buildings[buildingType].level = nextLevel;
                saveUserData();
                initShop();
                initCityView();
                showNotification(`Вы улучшили ${building.name} до уровня ${nextLevel}!`);
            } else {
                showNotification('Недостаточно Gamma Coin!', 'error');
            }
        }
        
        // Настройка обработчиков событий
        function setupEventListeners() {
            // Навигационные кнопки
            document.getElementById('shop-button').addEventListener('click', () => {
                document.getElementById('shop-modal').classList.add('active');
            });
            
            document.getElementById('events-button').addEventListener('click', () => {
                document.getElementById('events-modal').classList.add('active');
            });
            
            document.getElementById('leaderboard-button').addEventListener('click', () => {
                document.getElementById('leaderboard-modal').classList.add('active');
            });
            
            document.getElementById('exchange-button').addEventListener('click', () => {
                document.getElementById('exchange-modal').classList.add('active');
            });
            
            document.getElementById('city-button').addEventListener('click', () => {
                // Уже на главном экране
            });
            
            // Кнопки закрытия модальных окон
            document.getElementById('close-shop').addEventListener('click', () => {
                document.getElementById('shop-modal').classList.remove('active');
            });
            
            document.getElementById('close-events').addEventListener('click', () => {
                document.getElementById('events-modal').classList.remove('active');
            });
            
            document.getElementById('close-leaderboard').addEventListener('click', () => {
                document.getElementById('leaderboard-modal').classList.remove('active');
            });
            
            document.getElementById('close-exchange').addEventListener('click', () => {
                document.getElementById('exchange-modal').classList.remove('active');
            });
            
            document.getElementById('close-energy-roulette').addEventListener('click', () => {
                document.getElementById('energy-roulette-modal').classList.remove('active');
            });
            
            document.getElementById('close-luck-roulette').addEventListener('click', () => {
                document.getElementById('luck-roulette-modal').classList.remove('active');
            });
            
            document.getElementById('close-premium').addEventListener('click', () => {
                document.getElementById('premium-modal').classList.remove('active');
            });
            
            // Круглые кнопки
            document.getElementById('energy-roulette-button').addEventListener('click', () => {
                document.getElementById('energy-roulette-modal').classList.add('active');
            });
            
            document.getElementById('luck-roulette-button').addEventListener('click', () => {
                document.getElementById('luck-roulette-modal').classList.add('active');
            });
            
            document.getElementById('premium-button').addEventListener('click', () => {
                document.getElementById('premium-modal').classList.add('active');
            });
            
            // Рулетка энергии
            document.getElementById('spin-energy').addEventListener('click', spinEnergyRoulette);
            
            // Рулетка удачи
            document.getElementById('spin-luck').addEventListener('click', spinLuckRoulette);
            
            // Обмен
            document.getElementById('exchange-submit').addEventListener('click', exchangeCurrency);
            
            // Пополнение
            document.getElementById('deposit-submit').addEventListener('click', depositTon);
            
            // Вывод
            document.getElementById('withdraw-submit').addEventListener('click', withdrawTon);
            
            // Покупка премиума
            document.querySelectorAll('.buy-premium').forEach(button => {
                button.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    buyPremium(type);
                });
            });
            
            // Переключение вкладок в обмене
            document.querySelectorAll('.exchange-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabName = this.getAttribute('data-tab');
                    
                    // Убираем активный класс у всех вкладок и контента
                    document.querySelectorAll('.exchange-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.exchange-tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Добавляем активный класс текущей вкладке и контенту
                    this.classList.add('active');
                    document.getElementById(`${tabName}-tab`).classList.add('active');
                });
            });
        }
        
        // Запуск производства энергии
        function startEnergyProduction() {
            setInterval(() => {
                let producedEnergy = 0;
                
                for (const buildingType in userData.buildings) {
                    const building = userData.buildings[buildingType];
                    if (building.count > 0 && building.level > 0) {
                        const income = buildingData[buildingType].income[building.level - 1];
                        producedEnergy += income * building.count / 60; // Производство в минуту
                    }
                }
                
                if (producedEnergy > 0) {
                    userData.energy += Math.floor(producedEnergy);
                    userData.lastEnergyUpdate = new Date().toISOString();
                    updateBalances();
                    
                    // Сохраняем данные каждую минуту
                    if (new Date().getSeconds() === 0) {
                        saveUserData();
                    }
                }
            }, 60000); // Обновляем каждую минуту
        }
        
        // Загрузка лидерборда
        async function loadLeaderboard() {
            // В реальном приложении здесь будет запрос к серверу
            // Для демонстрации создаем фиктивные данные
            const leaderboard = [
                { id: userData.id, username: userData.username, energy: userData.energy, gamma: userData.gamma, ton: userData.ton },
                { id: 2, username: 'Player2', energy: 50000, gamma: 2000, ton: 10 },
                { id: 3, username: 'Player3', energy: 45000, gamma: 1800, ton: 9 },
                { id: 4, username: 'Player4', energy: 40000, gamma: 1500, ton: 8 },
                { id: 5, username: 'Player5', energy: 35000, gamma: 1200, ton: 7 },
                { id: 6, username: 'Player6', energy: 30000, gamma: 1000, ton: 6 },
                { id: 7, username: 'Player7', energy: 25000, gamma: 800, ton: 5 },
                { id: 8, username: 'Player8', energy: 20000, gamma: 600, ton: 4 },
                { id: 9, username: 'Player9', energy: 15000, gamma: 400, ton: 3 },
                { id: 10, username: 'Player10', energy: 10000, gamma: 200, ton: 2 }
            ];
            
            // Сортируем по энергии
            leaderboard.sort((a, b) => b.energy - a.energy);
            
            // Обновляем таблицу лидерборда
            const leaderboardBody = document.getElementById('leaderboard-body');
            leaderboardBody.innerHTML = '';
            
            leaderboard.forEach((player, index) => {
                const row = document.createElement('tr');
                if (player.id === userData.id) {
                    row.classList.add('user-rank');
                }
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.username}</td>
                    <td>${player.energy.toLocaleString()}</td>
                    <td>${player.gamma.toLocaleString()}</td>
                    <td>${player.ton.toLocaleString()}</td>
                `;
                
                leaderboardBody.appendChild(row);
            });
        }
        
        // Обновление лидерборда на сервере
        async function updateLeaderboard() {
            // В реальном приложении здесь будет запрос к серверу
            // Для демонстрации просто перезагружаем лидерборд
            loadLeaderboard();
        }
        
        // Проверка премиум статуса
        function checkPremiumStatus() {
            if (userData.premium.active && userData.premium.expires) {
                const now = new Date();
                const expires = new Date(userData.premium.expires);
                
                if (now > expires && userData.premium.type === 'monthly') {
                    userData.premium.active = false;
                    userData.premium.type = null;
                    userData.premium.expires = null;
                    saveUserData();
                    showNotification('Ваш премиум статус истек!');
                }
            }
            
            // Обновляем отображение премиум кнопки
            const premiumButton = document.getElementById('premium-button');
            if (userData.premium.active) {
                premiumButton.classList.add('pulse');
                premiumButton.style.background = 'linear-gradient(135deg, #FFD700, #FFA500)';
            } else {
                premiumButton.classList.remove('pulse');
                premiumButton.style.background = 'linear-gradient(135deg, #6e8efb, #a777e3)';
            }
        }
        
        // Рулетка энергии
        function spinEnergyRoulette() {
            const now = new Date();
            const lastSpin = userData.lastEnergyRoulette ? new Date(userData.lastEnergyRoulette) : null;
            
            // Проверяем, можно ли крутить рулетку
            if (lastSpin && (now - lastSpin) < 24 * 60 * 60 * 1000) {
                const nextSpin = new Date(lastSpin.getTime() + 24 * 60 * 60 * 1000);
                const hoursLeft = Math.floor((nextSpin - now) / (1000 * 60 * 60));
                showNotification(`Вы уже крутили рулетку сегодня. Следующая попытка через ${hoursLeft} часов.`, 'error');
                return;
            }
            
            // Анимация вращения
            const wheel = document.getElementById('energy-wheel');
            const resultElement = document.getElementById('energy-roulette-result');
            const spinButton = document.getElementById('spin-energy');
            
            spinButton.disabled = true;
            resultElement.textContent = '';
            
            // Вращаем колесо
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            
            setTimeout(() => {
                wheel.style.transition = 'transform 3s ease-out';
                
                // Случайный угол вращения (от 2 до 5 полных оборотов + случайный сектор)
                const spins = 2 + Math.floor(Math.random() * 4);
                const sector = Math.floor(Math.random() * 12) * 30; // 12 секторов по 30 градусов
                const rotation = spins * 360 + sector;
                
                wheel.style.transform = `rotate(${rotation}deg)`;
                
                // Определяем выигрыш через 3 секунды
                setTimeout(() => {
                    // Выигрыш от 100 до 2000 энергии
                    const minWin = 100;
                    const maxWin = 2000;
                    const winAmount = Math.floor(Math.random() * (maxWin - minWin + 1)) + minWin;
                    
                    userData.energy += winAmount;
                    userData.lastEnergyRoulette = now.toISOString();
                    saveUserData();
                    
                    resultElement.textContent = `Вы выиграли ${winAmount} ⚡ энергии!`;
                    spinButton.disabled = false;
                    
                    showNotification(`Вы получили ${winAmount} ⚡ энергии!`);
                }, 3000);
            }, 10);
        }
        
        // Рулетка удачи
        function spinLuckRoulette() {
            if (userData.ton < 1) {
                showNotification('Недостаточно TON для запуска рулетки!', 'error');
                return;
            }
            
            // Анимация вращения
            const wheel = document.getElementById('luck-wheel');
            const resultElement = document.getElementById('luck-roulette-result');
            const spinButton = document.getElementById('spin-luck');
            
            spinButton.disabled = true;
            resultElement.textContent = '';
            
            // Вращаем колесо
            wheel.style.transition = 'none';
            wheel.style.transform = 'rotate(0deg)';
            
            setTimeout(() => {
                wheel.style.transition = 'transform 3s ease-out';
                
                // Случайный угол вращения (от 2 до 5 полных оборотов + случайный сектор)
                const spins = 2 + Math.floor(Math.random() * 4);
                const sector = Math.floor(Math.random() * 12) * 30; // 12 секторов по 30 градусов
                const rotation = spins * 360 + sector;
                
                wheel.style.transform = `rotate(${rotation}deg)`;
                
                // Определяем выигрыш через 3 секунды
                setTimeout(() => {
                    // 99% шанс выиграть 0.5-1 TON, 1% шанс выиграть 1-5 TON
                    const isBigWin = Math.random() < 0.01;
                    let winAmount;
                    
                    if (isBigWin) {
                        winAmount = 1 + Math.random() * 4; // 1-5 TON
                    } else {
                        winAmount = 0.5 + Math.random() * 0.5; // 0.5-1 TON
                    }
                    
                    winAmount = parseFloat(winAmount.toFixed(2));
                    
                    // Вычитаем стоимость крутки
                    userData.ton -= 1;
                    userData.ton += winAmount;
                    saveUserData();
                    
                    resultElement.textContent = `Вы выиграли ${winAmount} 💎 TON!`;
                    spinButton.disabled = false;
                    
                    if (isBigWin) {
                        showNotification(`ОГРОМНЫЙ ВЫИГРЫШ! Вы получили ${winAmount} 💎 TON!`, 'success');
                    } else {
                        showNotification(`Вы получили ${winAmount} 💎 TON!`);
                    }
                }, 3000);
            }, 10);
        }
        
        // Обмен валюты
        function exchangeCurrency() {
            const from = document.getElementById('exchange-from').value;
            const to = document.getElementById('exchange-to').value;
            const amount = parseFloat(document.getElementById('exchange-amount').value);
            
            if (isNaN(amount) {
                showNotification('Введите корректную сумму!', 'error');
                return;
            }
            
            if (amount <= 0) {
                showNotification('Сумма должна быть больше нуля!', 'error');
                return;
            }
            
            // Проверяем достаточность средств
            if (from === 'energy' && userData.energy < amount) {
                showNotification('Недостаточно энергии!', 'error');
                return;
            }
            
            if (from === 'gamma' && userData.gamma < amount) {
                showNotification('Недостаточно Gamma Coin!', 'error');
                return;
            }
            
            if (from === 'ton' && userData.ton < amount) {
                showNotification('Недостаточно TON!', 'error');
                return;
            }
            
            // Выполняем обмен
            let result = 0;
            
            if (from === 'energy' && to === 'gamma') {
                result = amount * exchangeRates.energyToGamma;
                userData.energy -= amount;
                userData.gamma += result;
            } 
            else if (from === 'gamma' && to === 'ton') {
                result = amount * exchangeRates.gammaToTon;
                userData.gamma -= amount;
                userData.ton += result;
            }
            else if (from === 'ton' && to === 'gamma') {
                result = amount * exchangeRates.tonToGamma;
                userData.ton -= amount;
                userData.gamma += result;
            }
            else if (from === 'gamma' && to === 'energy') {
                result = amount / exchangeRates.energyToGamma;
                userData.gamma -= amount;
                userData.energy += result;
            }
            else {
                showNotification('Такой обмен невозможен!', 'error');
                return;
            }
            
            saveUserData();
            showNotification(`Обмен успешен! Вы получили ${result.toFixed(2)} ${to === 'gamma' ? 'Γ' : to === 'ton' ? '💎 TON' : '⚡'}`);
        }
        
        // Пополнение TON
        function depositTon() {
            const amount = parseFloat(document.getElementById('deposit-amount').value);
            
            if (isNaN(amount)) {
                showNotification('Введите корректную сумму!', 'error');
                return;
            }
            
            if (amount < 1 || amount > 100) {
                showNotification('Сумма пополнения должна быть от 1 до 100 TON!', 'error');
                return;
            }
            
            // В реальном приложении здесь будет вызов платежной системы Telegram
            showLoading(true);
            
            // Имитация платежа
            setTimeout(() => {
                showLoading(false);
                
                // В реальном приложении здесь будет проверка успешности платежа
                const paymentSuccess = true; // Для демонстрации всегда успех
                
                if (paymentSuccess) {
                    userData.ton += amount;
                    saveUserData();
                    showNotification(`Пополнение на ${amount} TON успешно!`);
                    
                    // Закрываем модальное окно
                    document.getElementById('exchange-modal').classList.remove('active');
                } else {
                    showNotification('Ошибка при пополнении. Попробуйте позже.', 'error');
                }
            }, 2000);
        }
        
        // Вывод TON
        function withdrawTon() {
            const amount = parseFloat(document.getElementById('withdraw-amount').value);
            const address = document.getElementById('withdraw-address').value.trim();
            
            if (isNaN(amount)) {
                showNotification('Введите корректную сумму!', 'error');
                return;
            }
            
            if (amount <= 0) {
                showNotification('Сумма должна быть больше нуля!', 'error');
                return;
            }
            
            if (userData.ton < amount) {
                showNotification('Недостаточно TON для вывода!', 'error');
                return;
            }
            
            if (!address || address.length < 10) {
                showNotification('Введите корректный адрес кошелька!', 'error');
                return;
            }
            
            // Проверяем, прошло ли 100 дней с регистрации
            const regDate = new Date(userData.registrationDate);
            const now = new Date();
            const daysPassed = (now - regDate) / (1000 * 60 * 60 * 24);
            
            if (daysPassed < 100) {
                const daysLeft = Math.ceil(100 - daysPassed);
                showNotification(`Вывод доступен только через ${daysLeft} дней после регистрации!`, 'error');
                return;
            }
            
            // Комиссия 5%
            const commission = amount * 0.05;
            const finalAmount = amount - commission;
            
            // В реальном приложении здесь будет запрос к серверу для вывода
            showLoading(true);
            
            setTimeout(() => {
                showLoading(false);
                
                // В реальном приложении здесь будет проверка успешности вывода
                const withdrawSuccess = true; // Для демонстрации всегда успех
                
                if (withdrawSuccess) {
                    userData.ton -= amount;
                    saveUserData();
                    showNotification(`Вывод ${finalAmount.toFixed(2)} TON (комиссия 5%) успешно отправлен на кошелек ${address}`);
                    
                    // Закрываем модальное окно
                    document.getElementById('exchange-modal').classList.remove('active');
                } else {
                    showNotification('Ошибка при выводе. Попробуйте позже.', 'error');
                }
            }, 2000);
        }
        
        // Покупка премиум статуса
        function buyPremium(type) {
            let price, duration;
            
            if (type === 'monthly') {
                price = 5;
                duration = '1 месяц';
            } else if (type === 'lifetime') {
                price = 30;
                duration = 'навсегда';
            } else {
                showNotification('Неверный тип премиум статуса!', 'error');
                return;
            }
            
            if (userData.ton < price) {
                showNotification(`Недостаточно TON для покупки премиум статуса (${price} TON)!`, 'error');
                return;
            }
            
            // В реальном приложении здесь будет вызов платежной системы Telegram
            showLoading(true);
            
            setTimeout(() => {
                showLoading(false);
                
                // В реальном приложении здесь будет проверка успешности платежа
                const paymentSuccess = true; // Для демонстрации всегда успех
                
                if (paymentSuccess) {
                    userData.ton -= price;
                    userData.premium.active = true;
                    userData.premium.type = type;
                    
                    if (type === 'monthly') {
                        const expires = new Date();
                        expires.setMonth(expires.getMonth() + 1);
                        userData.premium.expires = expires.toISOString();
                    } else {
                        userData.premium.expires = null;
                    }
                    
                    saveUserData();
                    checkPremiumStatus();
                    initShop(); // Обновляем магазин, чтобы показать премиум здания
                    
                    showNotification(`Премиум статус на ${duration} успешно активирован!`);
                    
                    // Закрываем модальное окно
                    document.getElementById('premium-modal').classList.remove('active');
                } else {
                    showNotification('Ошибка при покупке премиум статуса. Попробуйте позже.', 'error');
                }
            }, 2000);
        }
        
        // Показать уведомление
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = 'notification';
            
            if (type === 'error') {
                notification.style.background = 'rgba(255, 0, 0, 0.7)';
            } else if (type === 'success') {
                notification.style.background = 'rgba(0, 128, 0, 0.7)';
            } else {
                notification.style.background = 'rgba(0, 0, 0, 0.7)';
            }
            
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Показать/скрыть загрузку
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
    </script>
</body>
</html>
